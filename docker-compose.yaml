version: "3.9"

networks:
  blockchain-bitcoin:
    name: blockchain-bitcoin-net

services:

  postgres:
    container_name: bitcoin-transactions-postgres-dev-server
    image: debezium/postgres:14-alpine
    user: postgres
    environment:
      POSTGRES_DB: bitcoin-transactions         # PostgreSQL database
      POSTGRES_USER: postgres                   # PostgreSQL user
      POSTGRES_PASSWORD: postgres               # PostgreSQL password
    ports:
      - 5432:5432
    volumes:
      - ./services/database/config:/docker-entrypoint-initdb.d
      #- ./services/database/data:/var/lib/postgresql/data
    networks:
      - blockchain-bitcoin
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      options:
        max-size: 10m
        max-file: "3"

  #############
  # postgrest #
  #############
  postgrest:
    container_name: bitcoin-transactions-postgrest-dev-server
    image: marcellodesales/blockchain-postgres-rest-wrapper
    build:
      context: services/database-rest-wrapper
      args:
        BASE_IMAGE: postgrest/postgrest:v9.0.0.20220211
    ports:
      - "4565:3000"
    # Available environment variables documented here:
    # https://postgrest.org/en/latest/configuration.html#environment-variables
    environment:
      # The standard connection URI format, documented at
      # https://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-CONNSTRING
      - PGRST_DB_URI=postgres://postgres:postgres@bitcoin-transactions-postgres-dev-server:5432/bitcoin-transactions
      # The name of which database schema to expose to REST clients
      - PGRST_DB_SCHEMA=bitcoin
      # The database role to use when no client authentication is provided
      - PGRST_DB_ANON_ROLE=api_anon
      # Overrides the base URL used within the OpenAPI self-documentation hosted at the API root path
      # This port is the one on the host exposed by docker-compose under ports
      - PGRST_OPENAPI_SERVER_PROXY_URI=http://localhost:4565
    networks:
      - blockchain-bitcoin
    restart: always

    depends_on:
      postgres:
        condition: service_healthy

    # https://medium.com/geekculture/how-to-successfully-implement-a-healthcheck-in-docker-compose-efced60bc08e
    healthcheck:
      # docker exec -ti postgrest which wget ---> /usr/bin/wget, the internal port within the container
      test: wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1
      interval: 30s
      timeout: 5s
      retries: 5
